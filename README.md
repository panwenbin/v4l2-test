test code forked from https://gist.github.com/Circuitsoft/1126411
